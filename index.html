<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <base target="_top">
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    * { box-sizing: border-box; }
    body { 
      font-family: 'Helvetica Neue', sans-serif; 
      background-color: #f5f5f5;
      margin: 0;
      padding: 0;
    }

    /* é ‚éƒ¨æ¨™é¡Œå€ */
    .header {
      background-color: #a71e32;
      color: white;
      padding: 20px;
      text-align: center;
    }
    .header h1 {
      font-size: 26px;
      font-weight: bold;
      margin: 0;
    }
    .header p {
      font-size: 15px;
      margin: 6px 0 0;
      opacity: 0.85;
    }

    /* å‰©é¤˜æ•¸é‡ */
    .stock-bar {
      background: #fff3cd;
      border-bottom: 2px solid #ffc107;
      padding: 12px 20px;
      text-align: center;
      font-size: 17px;
      font-weight: bold;
      color: #856404;
    }

    /* å•†å“å¡ç‰‡ */
    .product-card {
      background: white;
      margin: 16px;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    /* åœ–ç‰‡å€ */
    .product-image {
      width: 100%;
      height: 200px;
      object-fit: cover;
      background-color: #f0e0e0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 60px;
    }
    .product-image img {
      width: 100%;
      height: 200px;
      object-fit: cover;
    }

    /* å•†å“è³‡è¨Š */
    .product-info {
      padding: 16px;
    }
    .product-name {
      font-size: 22px;
      font-weight: bold;
      color: #333;
    }
    .product-price {
      font-size: 20px;
      color: #a71e32;
      font-weight: bold;
      margin-top: 4px;
    }
    .product-desc {
      font-size: 14px;
      color: #888;
      margin-top: 6px;
    }

    /* è¡¨å–®å€ */
    .order-form {
      background: white;
      margin: 0 16px 16px;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .form-label {
      font-size: 16px;
      font-weight: bold;
      color: #444;
      margin-bottom: 8px;
    }
    .form-select {
      font-size: 17px;
      padding: 12px;
      border-radius: 10px;
      border: 1.5px solid #ddd;
      height: auto;
    }
    .form-select:focus {
      border-color: #a71e32;
      box-shadow: 0 0 0 3px rgba(167,30,50,0.15);
    }

    /* é€å‡ºæŒ‰éˆ• */
    .btn-order {
      background-color: #a71e32;
      border: none;
      color: white;
      font-size: 20px;
      font-weight: bold;
      padding: 16px;
      border-radius: 12px;
      width: 100%;
      margin-top: 8px;
      letter-spacing: 1px;
    }
    .btn-order:active {
      background-color: #8c192a;
    }

    /* loading */
    #loading {
      display: none;
      text-align: center;
      padding: 60px 20px;
    }
    #loading p {
      font-size: 18px;
      color: #666;
      margin-top: 16px;
    }
  </style>
</head>
<body>

  <!-- é ‚éƒ¨æ¨™é¡Œ -->
  <div class="header">
    <h1>ğŸ¥£ ç´…è±†æ¹¯ç·šä¸Šé»é¤</h1>
    <p>æ–°é®®ç¾ç…®ãƒ»æ¯æ—¥é™é‡</p>
  </div>

  <!-- å‰©é¤˜æ•¸é‡ -->
  <div class="stock-bar">
    ä»Šæ—¥å‰©é¤˜ï¼š<span id="remainQty">è®€å–ä¸­...</span> ç¢—
  </div>

  <div id="mainContent">
    <!-- å•†å“å¡ç‰‡ -->
    <div class="product-card">
      <!-- åœ–ç‰‡å€ï¼šæŠŠä¸‹é¢çš„ emoji æ›æˆ <img src="ä½ çš„åœ–ç‰‡ç¶²å€"> å³å¯ -->
      <div class="product-image">ğŸ¥£</div>
      <div class="product-info">
        <div class="product-name">æ‹›ç‰Œç´…è±†æ¹¯</div>
        <div class="product-price">NT$ 50 / ç¢—</div>
        <div class="product-desc">ç²¾é¸å¤§ç²’ç´…è±†ï¼Œæ¯æ—¥æ–°é®®ç†¬ç…®ï¼Œå†·ç†±çš†å®œ</div>
      </div>
    </div>

    <!-- è¨‚å–®è¡¨å–® -->
    <div class="order-form" id="orderForm">
      <div class="mb-3">
        <label class="form-label">ğŸ“¦ æ•¸é‡</label>
        <select class="form-select" id="quantity">
          <option value="1">1 ç¢—</option>
          <option value="2">2 ç¢—</option>
          <option value="3">3 ç¢—</option>
          <option value="4">4 ç¢—</option>
          <option value="5">5 ç¢—</option>
          <option value="6">6 ç¢—</option>
          <option value="7">7 ç¢—</option>
          <option value="8">8 ç¢—</option>
        </select>
      </div>
      <div class="mb-3">
        <label class="form-label">ğŸŒ¡ï¸ å†·ç†±é¸é …</label>
        <select class="form-select" id="temperature">
          <option value="ç†±">ç†±</option>
          <option value="å†°">å†°</option>
          <option value="å»å†°">å»å†°</option>
        </select>
      </div>
      <div class="mb-4">
        <label class="form-label">â° å–é¤æ™‚é–“</label>
        <select class="form-select" id="pickupTime">
          <option value="" disabled selected>è«‹é¸æ“‡æ™‚é–“</option>
        </select>
        <div class="form-text text-danger mt-1" id="timeNote"></div>
      </div>

      <button class="btn-order" onclick="submitOrder()">é€å‡ºè¨‚å–®</button>
    </div>
  </div>

  <!-- loading -->
  <div id="loading">
    <div class="spinner-border text-danger" style="width:50px;height:50px;" role="status"></div>
    <p>æ­£åœ¨è¨‚è³¼ä¸­ï¼Œè«‹ç¨å€™...</p>
  </div>

  <script>
    const LIFF_ID = "2009193127-tcK3Q6uD";
    const GAS_URL = "https://script.google.com/macros/s/AKfycbxW0nFumExkb4rtue9nsucqtZIZDtXfYJliYEpjEKMNgvdMu6Em8S1xGKETYZxJHhDYKQ/exec";

    window.onload = function() {
      initializeLiff();
      loadInventory();
      generateTimeSlots();
    };

    function initializeLiff() {
      liff.init({ liffId: LIFF_ID })
        .then(() => {
          if (!liff.isLoggedIn()) {
            liff.login();
          }
        })
        .catch((err) => {
          alert("LIFF åˆå§‹åŒ–å¤±æ•—: " + err);
        });
    }

    function loadInventory() {
      fetch(GAS_URL + "?action=getInventory")
        .then(res => res.json())
        .then(data => {
          document.getElementById("remainQty").innerText = data.qty;
          if (data.qty <= 0) {
            disableForm("ä»Šæ—¥å·²å”®å®Œ");
          }
        })
        .catch(() => {
          document.getElementById("remainQty").innerText = "è®€å–å¤±æ•—";
        });
    }

    function generateTimeSlots() {
      var select = document.getElementById("pickupTime");
      var now = new Date();
      var startHour = 10;
      var endHour = 20;

      for (var h = startHour; h < endHour; h++) {
        [0, 30].forEach(function(m) {
          var slotTime = new Date();
          slotTime.setHours(h, m, 0, 0);
          var diffMins = (slotTime - now) / 1000 / 60;

          if (diffMins > 5) {
            var timeStr = (h < 10 ? "0"+h : h) + ":" + (m === 0 ? "00" : "30");
            var option = document.createElement("option");
            option.value = timeStr;
            option.text = timeStr;
            select.add(option);
          }
        });
      }

      if (select.options.length === 1) {
        document.getElementById("timeNote").innerText = "ä»Šæ—¥å·²ç„¡å¯é ç´„æ™‚æ®µ";
      }
    }

    function submitOrder() {
      var qty = document.getElementById("quantity").value;
      var time = document.getElementById("pickupTime").value;
      var temp = document.getElementById("temperature").value;

      if (!time) { alert("è«‹é¸æ“‡å–é¤æ™‚é–“ï¼"); return; }

      document.getElementById("mainContent").style.display = "none";
      document.getElementById("loading").style.display = "block";

      liff.getProfile().then(profile => {
        var orderData = {
          action: "processOrder",
          userId: profile.userId,
          userName: profile.displayName,
          quantity: qty,
          pickupTime: time,
          temperature: temp
        };

        return fetch(GAS_URL, {
          method: "POST",
          body: JSON.stringify(orderData)
        });
      })
      .then(res => res.json())
      .then(result => {
        document.body.innerHTML = `
          <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100vh; font-family:sans-serif; background:#f5f5f5; padding:30px; text-align:center;">
            <div style="font-size:80px;">ğŸ¥£</div>
            <h2 style="color:#a71e32; margin-top:20px; font-size:28px;">è¨‚è³¼æˆåŠŸï¼</h2>
            <div style="background:white; border-radius:16px; padding:20px 30px; margin-top:20px; box-shadow:0 2px 8px rgba(0,0,0,0.1); font-size:18px; color:#555; line-height:1.8;">
              ${result.message}
            </div>
            <p style="color:#aaa; margin-top:30px; font-size:15px;">å¯ä»¥é—œé–‰æ­¤è¦–çª—äº†</p>
          </div>
        `;
      })
      .catch(err => {
        alert("ç™¼ç”ŸéŒ¯èª¤ï¼š" + err);
        document.getElementById("mainContent").style.display = "block";
        document.getElementById("loading").style.display = "none";
      });
    }

    function disableForm(msg) {
      document.getElementById("orderForm").style.display = "none";
      document.getElementById("loading").style.display = "block";
      document.getElementById("loading").innerHTML = `<h2 style="color:#a71e32;">${msg}</h2>`;
    }
  </script>
</body>
</html>
