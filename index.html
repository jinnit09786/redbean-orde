<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { padding: 20px; font-family: sans-serif; background-color: #f8f9fa; }
    .card { margin-top: 20px; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .btn-primary { background-color: #a71e32; border-color: #8c192a; }
    #loading { display: none; text-align: center; margin-top: 20px; }
  </style>
</head>
<body>
  <div class="container">
    <h3 class="text-center mb-4">ğŸ¥£ ç´…è±†æ¹¯ç·šä¸Šé»é¤</h3>
    
    <div class="alert alert-info text-center">
      ä»Šæ—¥å‰©é¤˜ï¼š<strong id="remainQty">è®€å–ä¸­...</strong> ç¢—
    </div>

    <div class="card p-4">
      <form id="orderForm">
        <div class="mb-3">
          <label class="form-label">æ•¸é‡ (æ¯ç¢— $50)</label>
          <select class="form-select" id="quantity">
            <option value="1">1 ç¢—</option>
            <option value="2">2 ç¢—</option>
            <option value="3">3 ç¢—</option>
            <option value="4">4 ç¢—</option>
            <option value="5">5 ç¢—</option>
            <option value="6">6 ç¢—</option>
            <option value="7">7 ç¢—</option>
            <option value="8">8 ç¢—</option>
          </select>
        </div>
        <div class="mb-3">
          <label class="form-label">å†·ç†±é¸é …</label>
          <select class="form-select" id="temperature">
            <option value="ç†±">ç†±</option>
            <option value="å†°">å†°</option>
            <option value="å»å†°">å»å†°</option>
          </select>
        </div>
        <div class="mb-3">
          <label class="form-label">å–é¤æ™‚é–“</label>
          <select class="form-select" id="pickupTime">
            <option value="" disabled selected>è«‹é¸æ“‡æ™‚é–“</option>
          </select>
          <div class="form-text text-danger" id="timeNote"></div>
        </div>
        <button type="button" class="btn btn-primary w-100 btn-lg" onclick="">é€å‡ºè¨‚å–®</button>
      </form>
    </div>

    <div id="loading">
      <div class="spinner-border text-danger" role="status"></div>
      <p>æ­£åœ¨è¨‚è³¼ä¸­ï¼Œè«‹ç¨å€™...</p>
    </div>
  </div>

  <script>
    // =============================================
    // !! é€™å…©å€‹æ›æˆä½ è‡ªå·±çš„ !!
    const LIFF_ID = "2009193127-tcK3Q6uD";
    const GAS_URL = "https://script.google.com/macros/s/AKfycbxW0nFumExkb4rtue9nsucqtZIZDtXfYJliYEpjEKMNgvdMu6Em8S1xGKETYZxJHhDYKQ/exec";
    // =============================================

    window.onload = function() {
      initializeLiff();
      loadInventory();
      generateTimeSlots();
    };

    // 1. åˆå§‹åŒ– LIFF
    function initializeLiff() {
      liff.init({ liffId: LIFF_ID })
        .then(() => {
          if (!liff.isLoggedIn()) {
            liff.login();
          }
        })
        .catch((err) => {
          alert("LIFF åˆå§‹åŒ–å¤±æ•—: " + err);
        });
    }

    // 2. è®€å–åº«å­˜ (æ”¹ç”¨ fetch å‘¼å« GAS)
    function loadInventory() {
      fetch(GAS_URL + "?action=getInventory")
        .then(res => res.json())
        .then(data => {
          document.getElementById("remainQty").innerText = data.qty;
          if (data.qty <= 0) {
            disableForm("å·²å”®å®Œ");
          }
        })
        .catch(err => {
          document.getElementById("remainQty").innerText = "è®€å–å¤±æ•—";
        });
    }

    // 3. ç”¢ç”Ÿæ™‚é–“é¸å–®
    function generateTimeSlots() {
      var select = document.getElementById("pickupTime");
      var now = new Date();
      var startHour = 10;
      var endHour = 20;

      for (var h = startHour; h < endHour; h++) {
        [0, 30].forEach(function(m) {
          var slotTime = new Date();
          slotTime.setHours(h, m, 0, 0);
          var diffMins = (slotTime - now) / 1000 / 60;

          if (diffMins > 5) {
            var timeStr = (h < 10 ? "0"+h : h) + ":" + (m === 0 ? "00" : "30");
            var option = document.createElement("option");
            option.value = timeStr;
            option.text = timeStr;
            select.add(option);
          }
        });
      }

      if (select.options.length === 1) {
        document.getElementById("timeNote").innerText = "ä»Šæ—¥å·²ç„¡å¯é ç´„æ™‚æ®µ";
      }
    }

    // 4. é€å‡ºè¨‚å–®
    function submitOrder() {
      var qty = document.getElementById("quantity").value;
      var time = document.getElementById("pickupTime").value;
      var temp = document.getElementById("temperature").value;

      if (!time) { alert("è«‹é¸æ“‡å–é¤æ™‚é–“ï¼"); return; }

      document.getElementById("orderForm").style.display = "none";
      document.getElementById("loading").style.display = "block";

      liff.getProfile().then(profile => {
        var orderData = {
          action: "processOrder",
          userId: profile.userId,
          userName: profile.displayName,
          quantity: qty,
          pickupTime: time,
          temperature: temp
        };

        return fetch(GAS_URL, {
          method: "POST",
          body: JSON.stringify(orderData)
        });
      })
      .then(res => res.json())
      .then(result => {
        // éš±è—è½‰åœˆåœˆï¼Œé¡¯ç¤ºæˆåŠŸç•«é¢
        document.getElementById("loading").style.display = "none";
        document.getElementById("orderForm").style.display = "none";
        
        // é¡¯ç¤ºè‡ªè¨‚çš„æˆåŠŸè¨Šæ¯
        document.body.innerHTML = `
          <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100vh; font-family:sans-serif;">
            <div style="font-size:60px;">ğŸ¥£</div>
            <h2 style="color:#a71e32; margin-top:20px;">è¨‚è³¼æˆåŠŸï¼</h2>
            <p style="font-size:18px; color:#555;">${result.message}</p>
            <p style="color:#aaa; margin-top:30px;">å¯ä»¥é—œé–‰æ­¤è¦–çª—äº†</p>
          </div>
        `;
      })
      .catch(err => {
        alert("ç™¼ç”ŸéŒ¯èª¤ï¼š" + err);
        document.getElementById("orderForm").style.display = "block";
        document.getElementById("loading").style.display = "none";
      });
    }

    function disableForm(msg) {
      document.getElementById("orderForm").style.display = "none";
      document.getElementById("loading").style.display = "block";
      document.getElementById("loading").innerHTML = "<h3>" + msg + "</h3>";
    }
  </script>
</body>
</html>
