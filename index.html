<!DOCTYPE html>
<html>

<head>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <base target="_top">
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Helvetica Neue', sans-serif;
      background-color: #f5f5f5;
      margin: 0;
      padding: 0;
    }

    .header {
      background-color: #a71e32;
      color: white;
      padding: 20px;
      text-align: center;
    }

    .header h1 {
      font-size: 26px;
      font-weight: bold;
      margin: 0;
    }

    .header p {
      font-size: 15px;
      margin: 6px 0 0;
      opacity: 0.85;
    }

    /* å“é …å¡ */
    .product-list {
      padding: 12px 16px 0;
    }

    .product-item {
      background: white;
      border-radius: 14px;
      padding: 16px;
      margin-bottom: 12px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .product-item.soldout {
      opacity: 0.45;
      pointer-events: none;
    }

    .product-left h3 {
      font-size: 20px;
      font-weight: bold;
      color: #333;
      margin: 0;
    }

    .product-left .price {
      font-size: 18px;
      color: #a71e32;
      font-weight: bold;
      margin-top: 2px;
    }

    .product-left .stock {
      font-size: 13px;
      color: #999;
      margin-top: 2px;
    }

    /* æ•¸é‡æ§åˆ¶ */
    .qty-control {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .qty-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: 2px solid #a71e32;
      background: white;
      color: #a71e32;
      font-size: 22px;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      user-select: none;
    }

    .qty-btn:active {
      background: #a71e32;
      color: white;
    }

    .qty-btn.disabled {
      border-color: #ddd;
      color: #ddd;
      pointer-events: none;
    }

    .qty-value {
      font-size: 22px;
      font-weight: bold;
      min-width: 28px;
      text-align: center;
    }

    /* è¡¨å–®å€ */
    .order-form {
      background: white;
      margin: 0 16px 16px;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .form-label {
      font-size: 16px;
      font-weight: bold;
      color: #444;
      margin-bottom: 8px;
    }

    .form-select,
    .form-control {
      font-size: 17px;
      padding: 12px;
      border-radius: 10px;
      border: 1.5px solid #ddd;
      height: auto;
    }

    .form-select:focus,
    .form-control:focus {
      border-color: #a71e32;
      box-shadow: 0 0 0 3px rgba(167, 30, 50, 0.15);
    }

    .note-counter {
      font-size: 12px;
      color: #aaa;
      text-align: right;
      margin-top: 4px;
    }

    .form-control::placeholder {
      color: #ccc;
    }

    .form-control::-webkit-input-placeholder {
      color: #ccc;
    }

    .form-control::-moz-placeholder {
      color: #ccc;
      opacity: 1;
    }

    /* å°è¨ˆåˆ— */
    .subtotal-bar {
      background: #fff3cd;
      border-top: 2px solid #ffc107;
      border-bottom: 2px solid #ffc107;
      padding: 14px 20px;
      text-align: center;
      font-size: 20px;
      font-weight: bold;
      color: #856404;
      position: sticky;
      bottom: 70px;
      z-index: 10;
    }

    /* é€å‡ºæŒ‰éˆ• */
    .btn-order {
      background-color: #a71e32;
      border: none;
      color: white;
      font-size: 20px;
      font-weight: bold;
      padding: 16px;
      border-radius: 12px;
      width: 100%;
      margin-top: 8px;
      letter-spacing: 1px;
    }

    .btn-order:disabled {
      background-color: #ccc;
    }

    .btn-order:active {
      background-color: #8c192a;
    }

    #loading {
      display: none;
      text-align: center;
      padding: 60px 20px;
    }

    #loading p {
      font-size: 18px;
      color: #666;
      margin-top: 16px;
    }

    .init-loading {
      text-align: center;
      padding: 60px 20px;
      color: #999;
      font-size: 17px;
    }
  </style>
</head>

<body>

  <div class="header">
    <h1>ğŸ¥£ ç·šä¸Šé»é¤</h1>
    <p>æ–°é®®ç¾ç…®ãƒ»æ¯æ—¥é™é‡</p>
  </div>

  <div id="mainContent">
    <div class="init-loading" id="initLoading">è¼‰å…¥å“é …ä¸­...</div>

    <!-- å“é …åˆ—è¡¨ï¼ˆå‹•æ…‹ç”Ÿæˆï¼‰ -->
    <div class="product-list" id="productList" style="display:none;"></div>

    <!-- å°è¨ˆ -->
    <div class="subtotal-bar" id="subtotalBar" style="display:none;">
      å°è¨ˆï¼š<span id="subtotalText">$0</span>
    </div>

    <!-- å…¶ä»–é¸é … -->
    <div class="order-form" id="orderForm" style="display:none;">
      <div class="mb-3">
        <label class="form-label">â° å–é¤æ™‚é–“</label>
        <select class="form-select" id="pickupTime">
          <option value="" disabled selected>è«‹é¸æ“‡æ™‚é–“</option>
        </select>
        <div class="form-text text-danger mt-1" id="timeNote"></div>
      </div>
      <div class="mb-4">
        <label class="form-label">ğŸ“ å‚™è¨»</label>
        <input type="text" class="form-control" id="note" maxlength="100" placeholder="ä¾‹ï¼šä¸è¦å¤ªç”œã€åŠ æ¹¯åœ“â€¦">
        <div class="note-counter"><span id="noteCount">0</span>/100</div>
      </div>
      <button class="btn-order" id="submitBtn" onclick="submitOrder()" disabled>é€å‡ºè¨‚å–®</button>
    </div>
  </div>

  <div id="loading">
    <div class="spinner-border text-danger" style="width:50px;height:50px;" role="status"></div>
    <p>æ­£åœ¨è¨‚è³¼ä¸­ï¼Œè«‹ç¨å€™...</p>
  </div>

  <script>
    const LIFF_ID = "2009193127-tcK3Q6uD";
    const GAS_URL = "https://script.google.com/macros/s/AKfycbxW0nFumExkb4rtue9nsucqtZIZDtXfYJliYEpjEKMNgvdMu6Em8S1xGKETYZxJHhDYKQ/exec";

    var products = []; // [{name, price, remaining, row}]
    var cart = {};     // { "ç´…è±†æ¹¯": 2, "ç¶ è±†æ¹¯": 1 }

    window.onload = function () {
      initializeLiff();
      loadProducts();
      generateTimeSlots();

      document.getElementById("note").addEventListener("input", function () {
        document.getElementById("noteCount").innerText = this.value.length;
      });
    };

    function initializeLiff() {
      liff.init({ liffId: LIFF_ID })
        .then(() => {
          if (!liff.isLoggedIn()) liff.login();
        })
        .catch((err) => alert("LIFF åˆå§‹åŒ–å¤±æ•—: " + err));
    }

    function loadProducts() {
      fetch(GAS_URL + "?action=getProducts")
        .then(res => res.json())
        .then(data => {
          products = data.products;
          renderProducts();
          document.getElementById("initLoading").style.display = "none";
          document.getElementById("productList").style.display = "block";
          document.getElementById("subtotalBar").style.display = "block";
          document.getElementById("orderForm").style.display = "block";
        })
        .catch(() => {
          document.getElementById("initLoading").innerText = "è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†";
        });
    }

    function renderProducts() {
      var html = "";
      products.forEach(function (p) {
        var qty = cart[p.name] || 0;
        var soldout = p.remaining <= 0;
        html += `
          <div class="product-item ${soldout ? 'soldout' : ''}" id="item-${p.name}">
            <div class="product-left">
              <h3>${p.name}</h3>
              <div class="price">$${p.price}</div>
              <div class="stock">å‰©é¤˜ ${p.remaining} ä»½</div>
            </div>
            <div class="qty-control">
              <div class="qty-btn ${qty <= 0 ? 'disabled' : ''}" onclick="changeQty('${p.name}', -1)">âˆ’</div>
              <div class="qty-value" id="qty-${p.name}">${qty}</div>
              <div class="qty-btn ${qty >= p.remaining ? 'disabled' : ''}" onclick="changeQty('${p.name}', 1)">+</div>
            </div>
          </div>
        `;
      });
      document.getElementById("productList").innerHTML = html;
    }

    function changeQty(name, delta) {
      var product = products.find(p => p.name === name);
      if (!product) return;
      var current = cart[name] || 0;
      var next = current + delta;
      if (next < 0) next = 0;
      if (next > product.remaining) next = product.remaining;
      cart[name] = next;
      if (next === 0) delete cart[name];
      renderProducts();
      updateSubtotal();
    }

    function updateSubtotal() {
      var total = 0;
      var hasItems = false;
      products.forEach(function (p) {
        if (cart[p.name]) {
          total += cart[p.name] * p.price;
          hasItems = true;
        }
      });
      document.getElementById("subtotalText").innerText = "$" + total;
      document.getElementById("submitBtn").disabled = !hasItems;
    }

    function generateTimeSlots() {
      var select = document.getElementById("pickupTime");
      var now = new Date();
      for (var h = 10; h < 20; h++) {
        [0, 30].forEach(function (m) {
          var slotTime = new Date();
          slotTime.setHours(h, m, 0, 0);
          if ((slotTime - now) / 1000 / 60 > 5) {
            var timeStr = (h < 10 ? "0" + h : h) + ":" + (m === 0 ? "00" : "30");
            var option = document.createElement("option");
            option.value = timeStr;
            option.text = timeStr;
            select.add(option);
          }
        });
      }
      if (select.options.length === 1) {
        document.getElementById("timeNote").innerText = "ä»Šæ—¥å·²ç„¡å¯é ç´„æ™‚æ®µ";
      }
    }

    function submitOrder() {
      var time = document.getElementById("pickupTime").value;
      var note = document.getElementById("note").value;

      if (!time) { alert("è«‹é¸æ“‡å–é¤æ™‚é–“ï¼"); return; }

      // çµ„å»º items é™£åˆ—
      var items = [];
      products.forEach(function (p) {
        if (cart[p.name] && cart[p.name] > 0) {
          items.push({ name: p.name, qty: cart[p.name], price: p.price });
        }
      });
      if (items.length === 0) { alert("è«‹è‡³å°‘é¸æ“‡ä¸€é …å•†å“ï¼"); return; }

      document.getElementById("mainContent").style.display = "none";
      document.getElementById("loading").style.display = "block";

      liff.getProfile().then(profile => {
        var orderData = {
          action: "processOrder",
          userId: profile.userId,
          userName: profile.displayName,
          pickupTime: time,
          note: note,
          items: items
        };

        return fetch(GAS_URL, {
          method: "POST",
          body: JSON.stringify(orderData)
        });
      })
        .then(res => res.json())
        .then(result => {
          if (result.status === "error") {
            alert(result.message);
            document.getElementById("mainContent").style.display = "block";
            document.getElementById("loading").style.display = "none";
            return;
          }
          var itemsSummary = items.map(i => i.name + "Ã—" + i.qty).join("ã€");
          document.body.innerHTML = `
          <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100vh; font-family:sans-serif; background:#f5f5f5; padding:30px; text-align:center;">
            <div style="font-size:80px;">ğŸ¥£</div>
            <h2 style="color:#a71e32; margin-top:20px; font-size:28px;">è¨‚è³¼æˆåŠŸï¼</h2>
            <div style="background:white; border-radius:16px; padding:20px 30px; margin-top:20px; box-shadow:0 2px 8px rgba(0,0,0,0.1); font-size:18px; color:#555; line-height:2;">
              <div>ğŸ“¦ ${itemsSummary}</div>
              <div>ğŸ’° å…± $${result.totalPrice}</div>
              <div>â° å–é¤æ™‚é–“ï¼š${time}</div>
              ${note ? '<div>ğŸ“ ' + note + '</div>' : ''}
            </div>
            <p style="color:#aaa; margin-top:30px; font-size:15px;">å¯ä»¥é—œé–‰æ­¤è¦–çª—äº†</p>
          </div>
        `;
        })
        .catch(err => {
          alert("ç™¼ç”ŸéŒ¯èª¤ï¼š" + err);
          document.getElementById("mainContent").style.display = "block";
          document.getElementById("loading").style.display = "none";
        });
    }
  </script>
</body>

</html>
