<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { font-family: sans-serif; background: #f5f5f5; margin: 0; padding: 0; }
    .header { background: #a71e32; color: white; padding: 16px 20px; display: flex; align-items: center; justify-content: space-between; }
    .header h1 { font-size: 20px; margin: 0; }
    .refresh-btn { background: white; color: #a71e32; border: none; border-radius: 8px; padding: 6px 14px; font-size: 14px; font-weight: bold; }
    .order-card { background: white; margin: 12px 16px; border-radius: 14px; padding: 16px; box-shadow: 0 2px 6px rgba(0,0,0,0.08); }
    .order-card.done { background: #e0e0e0; color: #888; }
    .order-info { font-size: 17px; line-height: 1.8; }
    .order-id { font-size: 12px; color: #bbb; margin-top: 4px; }
    .btn-group-custom { display: flex; gap: 8px; margin-top: 12px; }
    .btn-status { flex: 1; padding: 10px; border-radius: 10px; border: 2px solid #ddd; background: white; font-size: 14px; font-weight: bold; color: #555; }
    .btn-status.active-prepared { border-color: #f0a500; background: #fff8e1; color: #f0a500; }
    .btn-status.active-picked { border-color: #28a745; background: #e8f5e9; color: #28a745; }
    .btn-archive { flex: 1; padding: 10px; border-radius: 10px; border: 2px solid #ccc; background: #f5f5f5; font-size: 14px; color: #999; }
    .pickup-time { font-size: 22px; font-weight: bold; color: #a71e32; }
    .no-order { text-align: center; padding: 60px 20px; color: #aaa; font-size: 18px; }
    .summary-bar { background: white; margin: 12px 16px 0; border-radius: 14px; padding: 14px 18px; box-shadow: 0 2px 6px rgba(0,0,0,0.08); font-size: 16px; color: #555; }

    /* å¯†ç¢¼ç•«é¢ */
    #loginScreen { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; background: #f5f5f5; padding: 30px; }
    #loginScreen h2 { color: #a71e32; margin-bottom: 20px; }
    #pwdInput { font-size: 18px; padding: 12px; border-radius: 10px; border: 1.5px solid #ddd; width: 100%; max-width: 300px; text-align: center; }
    #loginBtn { margin-top: 12px; background: #a71e32; color: white; border: none; padding: 12px 30px; border-radius: 10px; font-size: 18px; width: 100%; max-width: 300px; }
    #loginError { color: red; margin-top: 10px; font-size: 15px; display: none; }
  </style>
</head>
<body>

  <!-- å¯†ç¢¼ç•«é¢ -->
  <div id="loginScreen">
    <h2>ğŸ¥£ åº—å“¡å¾Œå°</h2>
    <input type="password" id="pwdInput" placeholder="è«‹è¼¸å…¥å¯†ç¢¼">
    <button id="loginBtn" onclick="login()">é€²å…¥</button>
    <div id="loginError">å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹å†è©¦ä¸€æ¬¡</div>
  </div>

  <!-- ä¸»ç•«é¢ -->
  <div id="mainScreen" style="display:none;">
    <div class="header">
      <h1>ğŸ¥£ ä»Šæ—¥è¨‚å–®çœ‹æ¿</h1>
      <button class="refresh-btn" onclick="loadOrders()">é‡æ–°æ•´ç†</button>
    </div>
    <div id="summaryBar" class="summary-bar"></div>
    <div id="orderList"></div>
  </div>

  <script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbxW0nFumExkb4rtue9nsucqtZIZDtXfYJliYEpjEKMNgvdMu6Em8S1xGKETYZxJHhDYKQ/exec";
    var currentPwd = "";

    function login() {
      var pwd = document.getElementById("pwdInput").value;
      fetch(GAS_URL + "?action=getTodayOrders&pwd=" + encodeURIComponent(pwd))
        .then(res => res.json())
        .then(data => {
          if (data.error) {
            document.getElementById("loginError").style.display = "block";
          } else {
            currentPwd = pwd;
            document.getElementById("loginScreen").style.display = "none";
            document.getElementById("mainScreen").style.display = "block";
            renderOrders(data.orders);
          }
        });
    }

    // æŒ‰ Enter ä¹Ÿèƒ½ç™»å…¥
    document.getElementById("pwdInput").addEventListener("keydown", function(e) {
      if (e.key === "Enter") login();
    });

    function loadOrders() {
      fetch(GAS_URL + "?action=getTodayOrders&pwd=" + encodeURIComponent(currentPwd))
        .then(res => res.json())
        .then(data => renderOrders(data.orders));
    }

    function renderOrders(orders) {
      var list = document.getElementById("orderList");
      var summary = document.getElementById("summaryBar");

      if (orders.length === 0) {
        list.innerHTML = `<div class="no-order">ä»Šæ—¥å°šç„¡è¨‚å–®</div>`;
        summary.innerHTML = "";
        return;
      }

      // çµ±è¨ˆ
      var totalBowls = orders.reduce(function(sum, o) { return sum + parseInt(o.quantity); }, 0);
      summary.innerHTML = `å…± <strong>${orders.length}</strong> ç­†è¨‚å–®ãƒ»åˆè¨ˆ <strong>${totalBowls}</strong> ç¢—`;

      var html = "";
      orders.forEach(function(o) {
        var isDone = o.prepared && o.picked;
        html += `
          <div class="order-card ${isDone ? 'done' : ''}" id="card-${o.rowIndex}">
            <div class="order-info">
              <span class="pickup-time">â° ${o.pickupTime}</span>
              <div>ğŸ‘¤ ${o.userName}ã€€ğŸ“¦ ${o.quantity} ç¢—ã€€ğŸŒ¡ï¸ ${o.temperature}</div>
            </div>
            <div class="order-id">${o.orderId}</div>
            <div class="btn-group-custom">
              <button class="btn-status ${o.prepared ? 'active-prepared' : ''}" onclick="updateStatus(${o.rowIndex}, 'å·²å‚™é¤')">
                ${o.prepared ? 'âœ…' : 'â˜'} å·²å‚™é¤
              </button>
              <button class="btn-status ${o.picked ? 'active-picked' : ''}" onclick="updateStatus(${o.rowIndex}, 'å·²å–é¤')">
                ${o.picked ? 'âœ…' : 'â˜'} å·²å–é¤
              </button>
              <button class="btn-archive" onclick="archiveOrder(${o.rowIndex})">å°å­˜</button>
            </div>
          </div>
        `;
      });
      list.innerHTML = html;
    }

    function updateStatus(rowIndex, action, orderId) {
    // å…ˆæŠŠæŒ‰éˆ•è®Šç°ï¼Œçµ¦ä½¿ç”¨è€…åé¥‹
      var card = document.getElementById("card-" + rowIndex);
      card.style.opacity = "0.5";
    
      fetch(GAS_URL, {
        method: "POST",
        body: JSON.stringify({ action: "updateStatus", rowIndex: rowIndex, statusAction: action })
      })
      .then(res => res.json())
      .then(() => {
        // åªæ›´æ–°é€™å¼µå¡ç‰‡çš„ç‹€æ…‹ï¼Œä¸é‡æ–°è¼‰å…¥å…¨éƒ¨
        var btn = card.querySelector(".btn-status[data-action='" + action + "']");
        if (action === "å·²å‚™é¤") {
          var isActive = btn.classList.contains("active-prepared");
          btn.classList.toggle("active-prepared", !isActive);
          btn.innerHTML = (!isActive ? "âœ…" : "â˜") + " å·²å‚™é¤";
        } else if (action === "å·²å–é¤") {
          var isActive = btn.classList.contains("active-picked");
          btn.classList.toggle("active-picked", !isActive);
          btn.innerHTML = (!isActive ? "âœ…" : "â˜") + " å·²å–é¤";
        }
        // åˆ¤æ–·æ˜¯å¦å…©å€‹éƒ½å‹¾äº†ï¼Œè®Šç°
        var preparedDone = card.querySelector("[data-action='å·²å‚™é¤']").classList.contains("active-prepared");
        var pickedDone = card.querySelector("[data-action='å·²å–é¤']").classList.contains("active-picked");
        card.classList.toggle("done", preparedDone && pickedDone);
        card.style.opacity = "1";
      })
      .catch(() => {
        card.style.opacity = "1";
        alert("æ›´æ–°å¤±æ•—ï¼Œè«‹é‡è©¦");
      });
    }

    function archiveOrder(rowIndex) {
      if (!confirm("ç¢ºå®šå°å­˜é€™ç­†è¨‚å–®ï¼Ÿ")) return;
      var card = document.getElementById("card-" + rowIndex);
      card.style.opacity = "0.5";
    
      fetch(GAS_URL, {
        method: "POST",
        body: JSON.stringify({ action: "updateStatus", rowIndex: rowIndex, statusAction: "å°å­˜" })
      })
      .then(() => {
        // ç›´æ¥æŠŠå¡ç‰‡å¾ç•«é¢ç§»é™¤
        card.remove();
      })
      .catch(() => {
        card.style.opacity = "1";
        alert("å°å­˜å¤±æ•—ï¼Œè«‹é‡è©¦");
      });
    }
  </script>
</body>
</html>
